on:
  workflow_dispatch: {}
  push:
    branches: [main]
    paths:
      - apps/planner/**

permissions:
  contents: read
  packages: write

concurrency:
  group: ${{ github.workflow }}

env:
  APP_NAME: "seahax-planner"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Setup
        run: ./.github/workflows/setup.sh
      - name: Install
        run: pnpm install --frozen-lockfile
      - name: Build
        run: |
          set -e
          npx lerna --scope="$APP_NAME" run build
          npx lerna --scope="$APP_NAME" run build:docker -- -t "registry.digitalocean.com/seahax/${APP_NAME}:latest"
      - name: Check
        run: npx lerna --scope="$APP_NAME" run check
      - name: Deploy
        run: |
          docker login registry.digitalocean.com -u "${{ secrets.DOCR_USERNAME }}" -p "${{ secrets.DOCR_TOKEN }}"
          docker push "registry.digitalocean.com/seahax/${APP_NAME}:latest"
